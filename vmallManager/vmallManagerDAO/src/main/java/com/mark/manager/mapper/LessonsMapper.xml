<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mark.manager.mapper.LessonsMapper">
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Nov 27 17:05:37 CST 2018.
        -->
        <where>
            <trim prefix="(" prefixOverrides="and" suffix=")">
                and lesson_id IN
                <foreach close=")" collection="lessonIds" item="id" open="(" separator=",">
                    #{id}
                </foreach>
            </trim>
            <if test="lessonPid != null">
                and lesson_pid = #{lessonPid}
            </if>
            and lesson_course_id = #{courseId}
            and lesson_is_chapter_head = #{isTitle}
        </where>
    </sql>

    <update id="updateLessonsSequence">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Nov 27 17:05:37 CST 2018.
        -->
        update vpro_courses_lesson_list
        <set>
            lesson_lid = `lesson_lid`
            <choose>
                <when test="type == 1 or type == 3">
                    <![CDATA[ + ]]>
                </when>
                <when test="type == 2">
                    <![CDATA[ - ]]>
                </when>
            </choose>
            #{offset,jdbcType=INTEGER}
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause" />
        </if>
    </update>

    <!--在根据课程移动的目标位置，整体移动腾出空间-->
    <!--这里的opsType是 向上向下移动标记 + 处于节点上方还是下方位置的标记 的 总和-->
    <select id="getLessonsNeedReLocation" resultType="java.lang.Integer">
      SELECT
         lesson_id
      from
        vpro_courses_lesson_list
      WHERE
        <trim prefixOverrides="and">
            and lesson_lid
            <choose>
                <when test="opsType == 2">
                    <![CDATA[ >= ]]>
                </when>
                <when test="opsType == 3 or opsType == 4">
                    <![CDATA[ > ]]>
                </when>
            </choose>
            #{start,jdbcType=INTEGER}
            AND
            lesson_lid
            <choose>
                <when test="opsType == 2 or opsType == 3">
                    <![CDATA[ < ]]>
                </when>
                <when test="opsType == 4">
                    <![CDATA[ <= ]]>
                </when>
            </choose>
            #{end,jdbcType=INTEGER}
            <!--<if test="type == 3">-->
                <!--and lesson_lid <![CDATA[ >= ]]> #{start,jdbcType=INTEGER} and lesson_lid <![CDATA[ <= ]]> #{end,jdbcType=INTEGER}-->
            <!--</if>-->
            AND lesson_course_id <![CDATA[=]]> #{courseId,jdbcType=INTEGER}
            AND lesson_is_chapter_head <![CDATA[=]]> #{isTitle}
        </trim>
    </select>

    <!--获得副标题下的第一个或这最后一个lid-->
    <select id="getLessonLidSpecified" resultType="java.lang.Integer">
        SELECT
        <choose>
            <when test="type == 1">
                MIN(lesson_lid)
            </when>
            <when test="type == 2">
                MAX(lesson_lid)
            </when>
        </choose>
        FROM
          vpro_courses_lesson_list
        WHERE
          lesson_course_id = #{courseId}
          AND lesson_pid = #{lessonPid}
    </select>
    
    <select id="getSubTitleLessonIdByLessonLid" resultType="java.lang.Integer">
        SELECT
          lesson_pid
        FROM
          vpro_courses_lesson_list
        WHERE
          lesson_lid = #{lessonLid}
          AND lesson_is_chapter_head = 1
    </select>
    
    <select id="getLessonsInnerTitle" resultType="java.lang.Integer">
        SELECT
          lesson_id
        FROM
          vpro_courses_lesson_list
        WHERE
          <choose>
              <when test="lessonIds != null">
                  <trim prefix="(" prefixOverrides="and" suffix=")">
                      and lesson_pid IN
                      <foreach close=")" collection="lessonIds" item="id" open="(" separator=",">
                          #{id}
                      </foreach>
                  </trim>
              </when>
              <when test=""></when>
          </choose>
          AND lesson_course_id = #{courseId}
    </select>

    <select id="getLastLessonLid" resultType="java.lang.Integer">
      SELECT
        MAX(lesson_lid)
      FROM
        vpro_courses_lesson_list
      where
        lesson_course_id = #{courseId}
        AND lesson_is_chapter_head = #{lessonIsChapterHead}
        <if test="lessonPid != null">
            AND lesson_pid = #{lessonPid}
        </if>
    </select>

    <select id="getLessonsListAnnonation">
SELECT
	vpro_courses_lesson_list.lesson_id,
	vpro_courses_lesson_list.lesson_lid,
	vpro_courses_lesson_list.lesson_pid,
	vpro_courses_lesson_list.lesson_title,
	vpro_courses_lesson_list.lesson_is_chapter_head,
	vpro_courses_lesson_list.lesson_course_id,
	vpro_courses_lesson_list.lesson_is_deleted,
	vpro_video.video_id,
	vpro_video.video_file_id,
	vpro_video.video_author,
	vpro_video.video_tag,
	vpro_video.video_detail_id,
	vpro_video.video_lesson_isused,
	vpro_video_detail.detail_id,
	vpro_video_detail.detail_content,
	vpro_video_detail.detail_favorite,
	vpro_video_files.*
FROM
	vpro_courses_lesson_list
LEFT JOIN vpro_video ON vpro_video.video_lesson_id = vpro_courses_lesson_list.lesson_id and vpro_courses_lesson_list.lesson_is_chapter_head = 0
LEFT JOIN vpro_video_detail ON vpro_video_detail.detail_lesson_id = vpro_courses_lesson_list.lesson_id and vpro_courses_lesson_list.lesson_is_chapter_head = 0
LEFT JOIN vpro_video_files ON vpro_video_files.video_file_lesson_id = vpro_courses_lesson_list.lesson_id and vpro_courses_lesson_list.lesson_is_chapter_head = 0
WHERE
	vpro_courses_lesson_list.lesson_course_id = 215015
    </select>

</mapper>